# v3

- 将模型改为DDP，放在集群4卡训练
- 识别器和超分器分开，先训练超分，不接入识别器


# todo

现在尝试过的模型：以下方法都达不到TSRN的指标

- [x] TSRN+两个PixelShuffle+识别器，一起训练：效果不行
- [x] TSRN+两个PixelShuffle不加识别器，效果一般，
- [x] TSRN+一个PixelShuffle不加识别器训练，效果一般
- [x] TSRN+一个PixelShuffle，使用1024batchsize和4卡训练，效果最好为21.9（在easy上测试）

还要尝试的：

- [x] 自己练一个TSRN：先用自己实现的版本，不使用分模块编写，全部写在一个模块里面 **这一版达到PSNR=23.8**，目前使用该版作为SR参数，参数文件`best_psnr_sr_model.pth`，`v2`的参数文件测试的时候效果差一些
- [x] 微调CRNN，重新训练分类头 **准确率67%**
  - [x] 单独训练超分任务
  - [ ] 和识别器一起训练

目前任务：

**注意：每个模块加一个wrapper，统一DDP用module的形式**

- [x] 使用分模块训练，把模型架构搭完，注意load参数时不要分模块load，一次性load并且使用`strict=False`
- [x] 把参数load进完整模型后测试一下，再保存为新的参数，方便下次一次性load
- [x] 联合训练
  - [x] 特征层训练（不需要load预训练，load整个模型，识别器从特征层开始微调）
  - [x] 图像层训练（需要load预训练）-> 保底


# expr

## Train with avg-loss

**Use `best_acc_model.pth` for different models:**

| arch | E-ACC | M-ACC | H-ACC | A-ACC |
| ---- | ----- | ----- | ----- | ----- |
| dense       | 0.7024 | 0.5539 | 0.3939 | 0.5596 |
| mlp         | 0.6949 | 0.5367 | 0.3902 | 0.5502 |
| sidernn     | 0.7116 | 0.5518 | 0.3924 | 0.5619 |
| sidernn+mlp | 0.6900 | 0.5489 | 0.3931 | 0.5532 |

| arch | E-PSNR | M-PSNR | H-PSNR | A-PSNR |
| ---- | ----- | ----- | ----- | ----- |
| dense       | 22.9425 | 19.6690 | 20.6816 | 21.1911 |
| mlp         | 23.4046 | 19.7867 | 20.5768 | 21.3678 |
| sidernn     | 23.2228 | 19.5888 | 20.5785 | 21.2373 |
| sidernn+mlp | 23.4609 | 19.6837 | 20.5425 | 21.3449 |

| arch | E-SSIM | M-SSIM | H-SSIM | A-SSIM |
| ---- | ----- | ----- | ----- | ----- |
| dense       | 0.7886 | 0.5313 | 0.6212 | 0.6541 |
| mlp         | 0.7983 | 0.5276 | 0.6223 | 0.6568 |
| sidernn     | 0.7960 | 0.5267 | 0.6229 | 0.6559 |
| sidernn+mlp | 0.7908 | 0.5248 | 0.6155 | 0.6511 |

**Use `best_psnr_model.pth` for different models:**

| arch | E-ACC | M-ACC | H-ACC | A-ACC |
| ---- | ----- | ----- | ----- | ----- |
| dense       | 0.6955 | 0.5475 | 0.3954 | 0.5555 |
| mlp         | 0.6831 | 0.5426 | 0.3797 | 0.5445 |
| sidernn     | 0.7129 | 0.5567 | 0.3902 | 0.5633 |
| sidernn+mlp | 0.6516 | 0.5348 | 0.3872 | 0.5326 |

| arch | E-PSNR | M-PSNR | H-PSNR | A-PSNR |
| ---- | ----- | ----- | ----- | ----- |
| dense       | 23.4315 | 19.5881 | 20.7169 | 21.3568 |
| mlp         | 23.6898 | 20.0308 | 20.6995 | 21.5898 |
| sidernn     | 23.9595 | 19.8686 | 20.7116 | 21.6410 |
| sidernn+mlp | 23.9743 | 20.0631 | 20.7429 | 21.7188 |

| arch | E-SSIM | M-SSIM | H-SSIM | A-SSIM |
| ---- | ----- | ----- | ----- | ----- |
| dense       | 0.8028 | 0.5322 | 0.6300 | 0.6624 |
| mlp         | 0.8022 | 0.5313 | 0.6279 | 0.6612 |
| sidernn     | 0.8060 | 0.5295 | 0.6276 | 0.6619 |
| sidernn+mlp | 0.7951 | 0.5326 | 0.6226 | 0.6574 |


## Train with uncertainty-loss

**Use `best_acc_model.pth` for different models:**

| arch | E-ACC | M-ACC | H-ACC | A-ACC |
| ---- | ----- | ----- | ----- | ----- |
| dense       | 0.7024 | 0.5539 | 0.3939 | 0.5596 |
| mlp         | 0.6949 | 0.5367 | 0.3902 | 0.5502 |
| sidernn     | 0.7116 | 0.5518 | 0.3924 | 0.5619 |
| sidernn+mlp | 0.6962 | 0.5468 | 0.3931 | 0.5532 |

| arch | E-PSNR | M-PSNR | H-PSNR | A-PSNR |
| ---- | ----- | ----- | ----- | ----- |
| dense       | 22.9425 | 19.6690 | 20.6816 | 21.1911 |
| mlp         | 23.4046 | 19.7867 | 20.5768 | 21.3678 |
| sidernn     | 23.2228 | 19.5888 | 20.5785 | 21.2373 |
| sidernn+mlp | 23.4609 | 19.6837 | 20.5425 | 21.3449 |

| arch | E-SSIM | M-SSIM | H-SSIM | A-SSIM |
| ---- | ----- | ----- | ----- | ----- |
| dense       | 0.7886 | 0.5313 | 0.6212 | 0.6541 |
| mlp         | 0.7983 | 0.5276 | 0.6223 | 0.6568 |
| sidernn     | 0.7960 | 0.5267 | 0.6229 | 0.6559 |
| sidernn+mlp | 0.7908 | 0.5248 | 0.6155 | 0.6511 |

**Use `best_psnr_model.pth` for different models:**

| arch | E-ACC | M-ACC | H-ACC | A-ACC |
| ---- | ----- | ----- | ----- | ----- |
| dense       | 0.6955 | 0.5475 | 0.3954 | 0.5555 |
| mlp         | 0.6831 | 0.5426 | 0.3797 | 0.5445 |
| sidernn     | 0.7129 | 0.5567 | 0.3902 | 0.5633 |
| sidernn+mlp | 0.6961 | 0.5468 | 0.3879 | 0.5532 |

| arch | E-PSNR | M-PSNR | H-PSNR | A-PSNR |
| ---- | ----- | ----- | ----- | ----- |
| dense       | 23.4315 | 19.5881 | 20.7169 | 21.3568 |
| mlp         | 23.6898 | 20.0308 | 20.6995 | 21.5898 |
| sidernn     | 23.9595 | 19.8686 | 20.7116 | 21.6410 |
| sidernn+mlp | 23.9154 | 20.0395 | 20.8072 | 21.7092 |

| arch | E-SSIM | M-SSIM | H-SSIM | A-SSIM |
| ---- | ----- | ----- | ----- | ----- |
| dense       | 0.8028 | 0.5322 | 0.6300 | 0.6624 |
| mlp         | 0.8022 | 0.5313 | 0.6279 | 0.6612 |
| sidernn     | 0.8060 | 0.5295 | 0.6276 | 0.6619 |
| sidernn+mlp | 0.8037 | 0.5341 | 0.6321 | 0.6640 |
